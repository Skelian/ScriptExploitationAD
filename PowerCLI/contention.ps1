# Install-Module VMware.PowerCLI -AllowClobber

#####################################
### CrÃ©er et fermer une connexion ###
#####################################
#Le fqdn du serveur Vsphere
$srvName=""
#Forcer le certificat invalide 
Set-PowerCLIConfiguration -Scope User -InvalidCertificateAction Warn
# Set-PowerCLIConfiguration -Scope User -ParticipateInCeip $false
# Connexion, délai assez long
Connect-VIServer -Server $srvName

#instruction ici

$RessourcesRatio = Foreach($esx in Get-VMHost){

    $vmStat = Get-VM -Location $esx | Where-Object PowerState -eq 'PoweredOn' | Measure-Object -Property NumCpu,MemoryGB  -Sum | select -ExpandProperty Sum

    $esx | Select Name,@{N='pCPU';E={$_.NumCpu}},

        @{N='vCPU';E={$vmStat[0]}},

        @{N='CPU Ratio';E={[math]::Round($vmStat[0]/$_.NumCpu,1)}},

        @{N='pRAM';E={$_.NumCpu}},

        @{N='vRAM';E={$vmStat[1]}},

        @{N='RAM Ratio';E={[math]::Round($vmStat[1]/$_.MemoryTotalGB,1)}}

} 
$RessourcesRatio | Format-Table

# Deconnexion
Disconnect-VIServer -Force 
