# Install-Module VMware.PowerCLI -AllowClobber

#####################################
### CrÃ©er et fermer une connexion ###
#####################################
#Le fqdn du serveur Vsphere
$srvName="sv-fqdn"
#Forcer le certificat invalide 
Set-PowerCLIConfiguration -Scope User -InvalidCertificateAction Warn
# Set-PowerCLIConfiguration -Scope User -ParticipateInCeip $false
# Connexion, délai assez long
Connect-VIServer -Server $srvName

#instruction ici

# Définir la période d'analyse (dernier mois)
$startTime = (Get-Date).AddMonths(-1)
$endTime = Get-Date

# Initialiser un tableau pour stocker les résultats
$results = @()

foreach ($vm in Get-Datacenter "DCName" | Get-VM | Where-Object PowerState -eq 'PoweredOn') {
   Write-Host "Traitement de la VM : $($vm.Name)"

    # Récupérer les statistiques CPU (utilisation en pourcentage)
    $cpuStatsPercent = Get-Stat -Entity $vm -Stat "cpu.usage.average" -Start $startDate -Finish $endDate

    # Récupérer les statistiques mémoire (utilisation en pourcentage)
    $memStatsPercent = Get-Stat -Entity $vm -Stat "mem.usage.average" -Start $startDate -Finish $endDate

    # Trouver les pics d'utilisation
    $maxCpuPercent = ($cpuStatsPercent | Measure-Object -Property Value -Maximum).Maximum
    $maxMemPercent = ($memStatsPercent | Measure-Object -Property Value -Maximum).Maximum

    # Calculer les moyennes
    $cpuAverage = ($cpuStatsPercent | Measure-Object -Property Value -Average).Average
    $memAverage = ($memStatsPercent | Measure-Object -Property Value -Average).Average

    # Récupérer les ressources allouées
    $allocatedCpu = $vm.NumCpu
    $allocatedMemoryMb = $vm.MemoryMB

    # Déterminer si la VM est surdimensionnée ou sous-dimensionnée
    $cpuStatus = if ($cpuAverage -lt 25) { "Surdimensionnée" } elseif ($cpuAverage -gt 90) { "Sous-dimensionnée" } else { "Correctement dimensionnée" }
    $memStatus = if ($memAverage -lt 50) { "Surdimensionnée" } elseif ($memAverage -gt 90) { "Sous-dimensionnée" } else { "Correctement dimensionnée" }

    # Ajouter les résultats dans la liste
    $results += [PSCustomObject]@{
        VMName                    = $vm.Name
        AllocatedCPU              = $allocatedCpu
        CPU_UtilizationPercentage = $cpuAverage
        MaxCpuPercent             = [math]::Round($maxCpuPercent, 2)
        CPU_Status                = $cpuStatus
        AllocatedMemory_MB        = $allocatedMemoryMb
        AverageMemory_Percentage  = [math]::Round($memAverage, 2)
        MaxMemPercent             = [math]::Round($maxMemPercent, 2)
        Memory_Status             = $memStatus
    }
}

# Afficher les résultats
$results | Format-Table -AutoSize

# Exporter les résultats dans un fichier CSV
$results | Export-Csv -Path "VM_Dimensionnement.csv" -NoTypeInformation -Encoding UTF8

Write-Host "Analyse terminée. Les résultats sont exportés dans 'VM_Dimensionnement.csv'"

# Deconnexion
Disconnect-VIServer -Force 
